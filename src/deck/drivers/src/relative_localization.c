#include "relative_localization.h"
#include "debug.h"

#include <string.h>
#include <stdint.h>
#include <math.h>
#include "arm_math.h"
#include "FreeRTOS.h"
#include "task.h"

#include "param.h"

#include "log.h"
#include "system.h"
#include "semphr.h"
#include "swarm_ranging.h"
#include <radiolink.h>
#include "estimator_kalman.h"

static uint16_t MY_UWB_ADDRESS;
static bool isInit;

static float Qv = 0.2f;         // velocity deviation,初始值为1.0    -0.25
static float Qr = 0.1f;         // yaw rate deviation
static float Ruwb = 0.2f;       // ranging deviation                -0.5
static float InitCovPos = 0.2f; // 初始位置误差
static float InitCovYaw = 0.2f; // 初始偏航角误差

static relaVariable_t relaVar[RANGING_TABLE_SIZE];

static float A[STATE_DIM_rl][STATE_DIM_rl];
static float h[STATE_DIM_rl] = {0};
static arm_matrix_instance_f32 H = {1, STATE_DIM_rl, h};
static arm_matrix_instance_f32 Am = {STATE_DIM_rl, STATE_DIM_rl, (float *)A};

// Temporary matrices for the covariance updates
static float tmpNN1d[STATE_DIM_rl * STATE_DIM_rl];
static arm_matrix_instance_f32 tmpNN1m = {STATE_DIM_rl, STATE_DIM_rl, tmpNN1d};
static float tmpNN2d[STATE_DIM_rl * STATE_DIM_rl];
static arm_matrix_instance_f32 tmpNN2m = {STATE_DIM_rl, STATE_DIM_rl, tmpNN2d};
static float K[STATE_DIM_rl];
static arm_matrix_instance_f32 Km = {STATE_DIM_rl, 1, (float *)K};
static float tmpNN3d[STATE_DIM_rl * STATE_DIM_rl];
static arm_matrix_instance_f32 tmpNN3m = {STATE_DIM_rl, STATE_DIM_rl, tmpNN3d};
static float HTd[STATE_DIM_rl * 1];
static arm_matrix_instance_f32 HTm = {STATE_DIM_rl, 1, HTd};
static float PHTd[STATE_DIM_rl * 1];
static arm_matrix_instance_f32 PHTm = {STATE_DIM_rl, 1, PHTd};

static bool fullConnect = false;  // a flag for control (fly or not)
static uint32_t connectCount = 0; // watchdog for detecting the connection

static short vxj_t, vyj_t;
static short vxi_t, vyi_t;
static uint16_t hi_t, hj_t; // height of robot i and j

static float vxj, vyj, rj; // receive vx, vy, gz and distance
static float vxi, vyi, ri; // self vx, vy, gz
static uint16_t dij;       // distance between self i and other j
static float hi, hj;       // height of robot i and j

static currentNeighborAddressInfo_t currentNeighborAddressInfo;
// static int16_t initRelativePosition[RANGING_TABLE_SIZE][RANGING_TABLE_SIZE][STATE_DIM_rl - 1];/*用于在指定无人机的初始位置时使用,由于在同一水平面，为了节省内存就不用Z轴了*/


static int curi = 0;

// 初始时，所有无人机基于0号无人机的相对位置
//正方向编队方案
static const float_t initPositionRela0[15][STATE_DIM_rl] = {
    {0.0f, 0.0f, 0.0f},   // 0
    {-1.0f, 0.0f, 0.0f},  // 1
    {-1.5f, 0.0f, 0.0f},  // 2
    {-1.5f, 1.5f, 0.0f},  // 3
    {0.0f, 1.5f, 0.0f},   // 4
    {1.5f, 1.5f, 0.0f},   // 5
    {1.5f, 0.0f, 0.0f},   // 6
    {1.5, -1.5f, 0.0f},   // 7
    {0.0f, -1.5f, 0.0f},  // 8
    {0.0f, 0.0f, 0.0f},   // 9
    {0.0f, 0.0f, 0.0f}    // 10
};

// vxj = data[0][curi];
// vyj = data[1][curi];
// rj = data[2][curi];
// hj = data[3][curi];
// dij = data[4][curi];
// curi += 1;
static const data[5][769] = {-0.720000, -0.800000, -0.880000, -0.920000, -0.950000, -0.990000, -0.990000, -0.980000, -0.990000, -0.970000, -0.970000, -0.910000, -0.850000, -0.770000, -0.670000, -0.550000, -0.440000, -0.320000, -0.190000, -0.060000, 0.070000, 0.200000, 0.330000, 0.460000, 0.570000, 0.680000, 0.760000, 0.850000, 0.890000, 0.940000, 0.950000, 0.960000, 0.980000, 0.970000, 0.960000, 0.950000, 0.940000, 0.920000, 0.920000, 0.910000, 0.910000, 0.910000, 0.900000, 0.910000, 0.910000, 0.910000, 0.910000, 0.910000, 0.920000, 0.920000, 0.920000, 0.930000, 0.930000, 0.930000, 0.940000, 0.940000, 0.950000, 0.950000, 0.940000, 0.960000, 0.950000, 0.940000, 0.950000, 0.950000, 0.930000, 0.940000, 0.940000, 0.950000, 0.950000, 0.950000, 0.960000, 0.960000, 0.960000, 0.990000, 0.980000, 0.990000, 1.009999, 1.009999, 1.019999, 1.019999, 1.019999, 1.009999, 1.009999, 1.009999, 1.0, 0.990000, 0.990000, 0.980000, 0.970000, 0.960000, 0.960000, 0.960000, 0.990000, 0.990000, 0.980000, 0.990000, 0.990000, 1.009999, 1.009999, 0.970000, 0.940000, 0.850000, 0.770000, 0.670000, 0.570000, 0.460000, 0.340000, 0.240000, 0.129999, 0.0, -0.110000, -0.230000, -0.350000, -0.470000, -0.580000, -0.660000, -0.740000, -0.800000, -0.840000, -0.880000, -0.900000, -0.910000, -0.920000, -0.920000, -0.910000, -0.910000, -0.910000, -0.910000, -0.900000, -0.900000, -0.900000, -0.890000, -0.890000, -0.900000, -0.900000, -0.890000, -0.900000, -0.900000, -0.910000, -0.920000, -0.910000, -0.920000, -0.920000, -0.910000, -0.920000, -0.930000, -0.940000, -0.930000, -0.920000, -0.930000, -0.930000, -0.930000, -0.940000, -0.930000, -0.930000, -0.950000, -0.950000, -0.960000, -0.970000, -0.960000, -0.960000, -0.970000, -0.970000, -0.980000, -0.970000, -0.980000, -0.970000, -0.980000, -1.0, -0.990000, -0.990000, -1.0, -1.0, -1.009999, -1.0, -0.940000, -0.880000, -0.790000, -0.680000, -0.590000, -0.500000, -0.370000, -0.230000, -0.170000, -0.020000, 0.129999, 0.250000, 0.380000, 0.430000, 0.540000, 0.640000, 0.730000, 0.810000, 0.870000, 0.900000, 0.940000, 0.950000, 0.970000, 0.970000, 0.960000, 0.950000, 0.930000, 0.920000, 0.910000, 0.900000, 0.900000, 0.880000, 0.890000, 0.890000, 0.890000, 0.900000, 0.890000, 0.900000, 0.900000, 0.900000, 0.900000, 0.910000, 0.910000, 0.920000, 0.920000, 0.910000, 0.920000, 0.920000, 0.910000, 0.930000, 0.930000, 0.940000, 0.930000, 0.930000, 0.940000, 0.930000, 0.930000, 0.940000, 0.930000, 0.930000, 0.930000, 0.930000, 0.940000, 0.940000, 0.930000, 0.940000, 0.940000, 0.940000, 0.950000, 0.960000, 0.960000, 0.980000, 0.990000, 1.0, 0.980000, 0.930000, 0.890000, 0.800000, 0.700000, 0.620000, 0.510000, 0.410000, 0.290000, 0.180000, 0.060000, -0.060000, -0.190000, -0.300000, -0.420000, -0.530000, -0.630000, -0.710000, -0.790000, -0.850000, -0.890000, -0.940000, -0.950000, -0.960000, -0.980000, -0.960000, -0.940000, -0.940000, -0.920000, -0.920000, -0.910000, -0.900000, -0.900000, -0.890000, -0.890000, -0.890000, -0.890000, -0.880000, -0.890000, -0.890000, -0.900000, -0.900000, -0.900000, -0.910000, -0.910000, -0.910000, -0.920000, -0.920000, -0.920000, -0.930000, -0.930000, -0.940000, -0.940000, -0.940000, -0.950000, -0.960000, -0.950000, -0.980000, -0.970000, -0.980000, -0.980000, -0.980000, -1.0, -1.009999, -0.990000, -1.0, -0.990000, -0.990000, -1.0, -0.990000, -0.990000, -0.980000, -0.970000, -0.980000, -0.980000, -0.960000, -0.940000, -0.870000, -0.770000, -0.680000, -0.570000, -0.460000, -0.350000, -0.230000, -0.120000, 0.0, 0.120000, 0.250000, 0.370000, 0.480000, 0.590000, 0.680000, 0.760000, 0.820000, 0.860000, 0.910000, 0.930000, 0.950000, 0.960000, 0.960000, 0.960000, 0.940000, 0.920000, 0.920000, 0.910000, 0.900000, 0.900000, 0.900000, 0.880000, 0.890000, 0.890000, 0.900000, 0.900000, 0.890000, 0.900000, 0.910000, 0.910000, 0.920000, 0.910000, 0.910000, 0.920000, 0.920000, 0.930000, 0.920000, 0.920000, 0.930000, 0.920000, 0.920000, 0.930000, 0.930000, 0.930000, 0.940000, 0.940000, 0.940000, 0.940000, 0.940000, 0.940000, 0.940000, 0.930000, 0.940000, 0.940000, 0.940000, 0.960000, 0.970000, 0.990000, 0.990000, 0.990000, 1.0, 0.990000, 0.990000, 0.990000, 0.940000, 0.860000, 0.790000, 0.680000, 0.590000, 0.490000, 0.370000, 0.259999, 0.140000, 0.020000, -0.090000, -0.200000, -0.330000, -0.450000, -0.560000, -0.660000, -0.730000, -0.780000, -0.840000, -0.870000, -0.890000, -0.930000, -0.940000, -0.950000, -0.950000, -0.940000, -0.940000, -0.920000, -0.910000, -0.910000, -0.900000, -0.900000, -0.900000, -0.890000, -0.900000, -0.900000, -0.890000, -0.900000, -0.900000, -0.900000, -0.910000, -0.910000, -0.910000, -0.920000, -0.920000, -0.930000, -0.930000, -0.930000, -0.940000, -0.940000, -0.940000, -0.940000, -0.950000, -0.940000, -0.950000, -0.940000, -0.960000, -0.960000, -0.960000, -0.970000, -0.970000, -0.970000, -0.980000, -0.990000, -1.0, -1.009999, -1.009999, -1.029999, -1.029999, -1.019999, -1.029999, -1.029999, -1.019999, -1.029999, -1.019999, -0.960000, -0.900000, -0.810000, -0.720000, -0.610000, -0.500000, -0.380000, -0.259999, -0.140000, -0.060000, 0.090000, 0.230000, 0.350000, 0.460000, 0.570000, 0.660000, 0.740000, 0.810000, 0.850000, 0.890000, 0.940000, 0.950000, 0.960000, 0.970000, 0.950000, 0.940000, 0.930000, 0.920000, 0.920000, 0.910000, 0.900000, 0.890000, 0.900000, 0.890000, 0.900000, 0.900000, 0.900000, 0.900000, 0.910000, 0.900000, 0.910000, 0.920000, 0.920000, 0.930000, 0.930000, 0.940000, 0.930000, 0.930000, 0.920000, 0.920000, 0.930000, 0.940000, 0.940000, 0.950000, 0.950000, 0.950000, 0.950000, 0.970000, 0.970000, 0.980000, 0.980000, 0.980000, 0.990000, 0.990000, 0.970000, 0.980000, 0.980000, 0.970000, 0.970000, 0.910000, 0.840000, 0.750000, 0.650000, 0.550000, 0.440000, 0.320000, 0.220000, 0.100000, -0.010000, -0.120000, -0.250000, -0.370000, -0.490000, -0.590000, -0.690000, -0.740000, -0.800000, -0.850000, -0.870000, -0.900000, -0.920000, -0.910000, -0.930000, -0.920000, -0.900000, -0.910000, -0.910000, -0.910000, -0.910000, -0.910000, -0.900000, -0.900000, -0.900000, -0.900000, -0.900000, -0.890000, -0.910000, -0.910000, -0.900000, -0.910000, -0.910000, -0.900000, -0.910000, -0.910000, -0.920000, -0.910000, -0.910000, -0.930000, -0.930000, -0.920000, -0.940000, -0.930000, -0.920000, -0.940000, -0.940000, -0.940000, -0.940000, -0.940000, -0.950000, -0.950000, -0.940000, -0.960000, -0.950000, -0.960000, -0.960000, -0.960000, -0.980000, -0.990000, -0.990000, -1.0, -1.009999, -1.0, -1.019999, -0.990000, -0.960000, -0.860000, -0.380000, -0.110000, 0.030000, 0.170000, 0.300000, 0.420000, 0.530000, 0.640000, 0.730000, 0.800000, 0.870000, 0.920000, 0.950000, 0.980000, 0.990000, 1.0, 0.990000, 0.970000, 0.970000, 0.960000, 0.940000, 0.940000, 0.920000, 0.910000, 0.910000, 0.910000, 0.910000, 0.900000, 0.900000, 0.900000, 0.900000, 0.900000, 0.910000, 0.900000, 0.900000, 0.910000, 0.900000, 0.910000, 0.910000, 0.910000, 0.920000, 0.920000, 0.920000, 0.930000, 0.920000, 0.920000, 0.930000, 0.920000, 0.930000, 0.930000, 0.920000, 0.930000, 0.930000, 0.920000, 0.920000, 0.930000, 0.920000, 0.930000, 0.930000, 0.920000, 0.930000, 0.930000, 0.930000, 0.940000, 0.940000, 0.970000, 0.960000, 0.940000, 0.920000, 0.840000, 0.770000, 0.660000, 0.550000, 0.450000, 0.330000, 0.210000, 0.100000, -0.020000, -0.140000, -0.270000, -0.390000, -0.510000, -0.610000, -0.690000, -0.770000, -0.820000, -0.860000, -0.900000, -0.920000, -0.920000, -0.940000, -0.940000, -0.930000, -0.930000, -0.920000, -0.910000, -0.920000, -0.920000, -0.920000, -0.900000, -0.900000, -0.910000, -0.900000, -0.890000, -0.900000, -0.900000, -0.910000, -0.900000, -0.910000, -0.910000, -0.910000, -0.910000, -0.920000, -0.920000, -0.910000, -0.930000, -0.930000, -0.920000, -0.930000, -0.930000, -0.930000, -0.940000, -0.940000, -0.940000, -0.950000, -0.950000, -0.960000, -0.960000, -0.960000, -0.970000, -0.970000, -0.980000, -1.0, -1.0, -1.0, -1.009999, -1.0, -1.0, -1.0, -0.990000, -0.990000, -0.990000, -0.960000, -0.940000, -0.860000, -0.770000, -0.680000, -0.580000, 
-0.410000, -0.410000, -0.410000, -0.400000, -0.390000, -0.370000, -0.360000, -0.340000, -0.330000, -0.320000, -0.310000, -0.270000, -0.220000, -0.170000, -0.100000, -0.030000, 0.030000, 0.100000, 0.160000, 0.210000, 0.270000, 0.320000, 0.350000, 0.370000, 0.370000, 0.380000, 0.380000, 0.380000, 0.380000, 0.370000, 0.360000, 0.350000, 0.340000, 0.340000, 0.330000, 0.330000, 0.320000, 0.310000, 0.290000, 0.259999, 0.220000, 0.180000, 0.150000, 0.120000, 0.090000, 0.070000, 0.040000, 0.020000, 0.0, 0.0, 0.0, -0.010000, -0.010000, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.020000, 0.030000, 0.040000, 0.040000, 0.050000, 0.050000, 0.050000, 0.050000, 0.050000, 0.050000, 0.050000, 0.050000, 0.040000, 0.040000, 0.040000, 0.040000, 0.030000, 0.030000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.010000, 0.020000, 0.010000, 0.010000, 0.020000, 0.020000, 0.020000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.020000, 0.020000, 0.020000, 0.020000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.0, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.010000, 0.020000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.020000, 0.020000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.020000, 0.020000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.020000, 0.030000, 0.030000, 0.030000, 0.030000, 0.020000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.020000, 0.030000, 0.020000, 0.020000, 0.010000, 0.020000, 0.020000, 0.010000, 0.020000, 0.010000, 0.020000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.010000, 0.010000, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.020000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.0, 0.010000, 0.010000, 0.0, 0.010000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.030000, 0.030000, 0.030000, 0.030000, 0.040000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.020000, 0.030000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.010000, -0.010000, -0.010000, -0.010000, -0.010000, -0.010000, -0.010000, -0.010000, -0.020000, -0.020000, -0.020000, -0.020000, -0.020000, -0.020000, -0.020000, -0.020000, -0.010000, -0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.020000, 0.020000, 0.030000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.020000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.020000, 0.010000, 0.0, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.010000, 0.010000, 0.010000, 0.020000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.0, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.020000, 0.020000, 0.020000, 0.020000, 0.030000, 0.050000, 0.040000, 0.020000, 0.050000, 0.080000, 0.129999, 0.170000, 0.240000, 0.280000, 0.300000, 0.340000, 0.340000, 0.340000, 0.330000, 0.310000, 0.280000, 0.240000, 0.210000, 0.180000, 0.140000, 0.110000, 0.080000, 0.050000, 0.030000, 0.0, 0.0, -0.020000, -0.030000, -0.040000, -0.040000, -0.050000, -0.040000, -0.050000, -0.040000, -0.040000, -0.040000, -0.040000, -0.040000, -0.040000, -0.040000, -0.030000, -0.030000, -0.030000, -0.030000, -0.030000, -0.030000, -0.030000, -0.020000, -0.030000, -0.030000, -0.040000, -0.040000, -0.040000, -0.050000, -0.050000, -0.050000, -0.050000, -0.050000, -0.040000, -0.040000, -0.030000, -0.030000, -0.030000, -0.030000, -0.020000, -0.020000, -0.030000, -0.020000, -0.020000, -0.010000, -0.010000, -0.010000, -0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.030000, 0.020000, 0.020000, 0.030000, 0.030000, 0.030000, 0.020000, 0.020000, 0.020000, 0.020000, 0.020000, 0.010000, 0.010000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.010000, 0.020000, 0.030000, 0.030000, 0.030000, 0.020000, 0.010000,
-0.108888, -0.099744, -0.120785, -0.093810, -0.081334, -0.047355, -0.047990, -0.001204, 0.041583, 0.023363, 0.067088, 0.114693, 0.184344, 0.134552, 0.086653, 0.119370, 0.092336, 0.075605, 0.075651, 0.071388, 0.082363, 0.086249, 0.048577, 0.057850, 0.060544, 0.065419, 0.060015, 0.027706, 0.007330, 0.023107, 0.027674, 0.050822, 0.047375, 0.040596, 0.015284, 0.029848, 0.022850, -0.009732, 0.005086, 0.032796, 0.023808, -0.027963, -0.033557, -0.024840, -0.044535, -0.031652, -0.026470, -0.032280, -0.011410, 0.011387, 0.014337, 0.004190, -0.004734, -0.007405, -0.009946, -0.027374, -0.027114, -0.028857, -0.027730, -0.031109, -0.016663, -0.007875, 0.002513, -0.001088, 0.005394, 0.001428, 0.001472, -0.004721, -0.020333, -0.032832, -0.030871, -0.029015, -0.018401, -0.015906, 0.006983, 0.016032, 0.033733, 0.011035, 0.001701, 0.019510, 0.010652, 0.017667, -0.006346, -0.018906, -0.011561, 0.002012, -0.016043, -0.015204, 0.000938, 0.022386, -0.000283, -0.021100, -0.003292, -0.004382, 0.006658, 0.025393, -0.002570, -0.021321, -0.041012, -0.077311, -0.023111, 0.037989, 0.001263, -0.020204, 0.044278, 0.012957, 0.016751, 0.022443, 0.003831, -0.030864, -0.023947, -0.045545, -0.037702, -0.052465, -0.065292, -0.051069, -0.045730, -0.047333, -0.052361, -0.040956, -0.034592, -0.013301, -0.004255, -0.028739, -0.007258, 0.004217, -0.000841, -0.010825, 0.003607, 0.003695, -0.007361, 0.004643, 0.003495, 0.002042, 0.006915, -0.006691, 0.002711, 0.002531, 0.004245, 0.007998, -0.000850, 0.003022, 0.001393, 0.009203, 0.009776, -0.005188, -0.016044, -0.012687, -0.014044, -0.016410, -0.009391, -0.005895, -0.003490, 0.006489, -0.016943, -0.011391, -0.012285, -0.011060, -0.014960, -0.010253, 0.000145, -0.006295, 0.005610, 0.001950, 0.001385, 0.008311, 0.014309, 0.003986, 0.009230, -0.001011, 0.011060, 0.009721, 0.012226, 0.009953, 0.041096, -0.030244, -0.058460, -0.037487, 0.000804, 0.009506, 0.034879, 0.065343, 0.057260, 0.064865, 0.060823, 0.055447, 0.050469, 0.036595, 0.023832, 0.021131, 0.054565, 0.040137, 0.046356, 0.027090, 0.032063, 0.043716, 0.016888, -0.001137, 0.003241, 0.015472, 0.022326, 0.038834, 0.033893, 0.018028, 0.014749, -0.007978, -0.037479, -0.034689, -0.007976, 0.000066, 0.017566, -0.000724, -0.002069, -0.003176, -0.016323, -0.018852, -0.010741, -0.011373, -0.010624, -0.011789, 0.000820, 0.021372, 0.013412, 0.002014, 0.005713, -0.004449, -0.021302, -0.028841, -0.019781, -0.028788, -0.031298, -0.027683, -0.007525, -0.007794, 0.005072, 0.000323, -0.002210, -0.006191, -0.016945, -0.026456, -0.035165, -0.047144, -0.026892, -0.012413, -0.005354, 0.016768, 0.011402, -0.004167, -0.015105, -0.046837, -0.029641, 0.060610, 0.016015, -0.006656, 0.043725, 0.044769, 0.034193, 0.028964, 0.019724, -0.014632, -0.021683, -0.041763, -0.027869, -0.064846, -0.087512, -0.071502, -0.063888, -0.072290, -0.061690, -0.053840, -0.053045, -0.031582, -0.016843, -0.016888, -0.018021, -0.013620, -0.019564, -0.008414, -0.001897, -0.008235, 0.006421, -0.003866, -0.004677, 0.004531, 0.003405, -0.001548, 0.008895, 0.004096, 0.011500, 0.015743, 0.000687, 0.007716, 0.002270, 0.009498, 0.005390, 0.007623, 0.003606, -0.011543, -0.003645, 0.001512, -0.002645, -0.005333, -0.001248, -0.014678, 0.009944, -0.005010, -0.019754, -0.000502, -0.008067, -0.002891, -0.009987, -0.006310, -0.001884, -0.003018, -0.020380, -0.015579, 0.003656, -0.005331, 0.013769, -0.007257, 0.014359, 0.000860, 0.013111, 0.017317, 0.055921, -0.016360, -0.058116, -0.030282, 0.009373, -0.004009, 0.013395, 0.040199, 0.039787, 0.056235, 0.049482, 0.042281, 0.036103, 0.034883, 0.033593, 0.035747, 0.039911, 0.035205, 0.027781, 0.028327, 0.033974, 0.029557, 0.034468, 0.042952, 0.025327, 0.019521, 0.017052, -0.010065, -0.019016, -0.007091, -0.001488, 0.017038, 0.015303, -0.000902, -0.005528, -0.005922, -0.024260, -0.017106, -0.000843, 0.001720, 0.014421, 0.009574, 0.016499, -0.004382, -0.002438, 0.002248, -0.020074, -0.024567, -0.028959, -0.022474, -0.010264, -0.015407, -0.022005, -0.017464, -0.019859, -0.008021, -0.013534, -0.016544, 0.005696, 0.013937, 0.016943, 0.022847, 0.001320, -0.001467, -0.012184, -0.025982, -0.037782, -0.022521, 0.001028, 0.017805, 0.008577, -0.003038, -0.025873, -0.021652, -0.010801, -0.055528, -0.057306, 0.042923, 0.019560, 0.000603, 0.027545, -0.002115, -0.017730, 0.000526, 0.019958, -0.001266, -0.004423, -0.014801, -0.031279, -0.059600, -0.043311, -0.049057, -0.043227, -0.039154, -0.057454, -0.043436, -0.036321, -0.026352, -0.022718, -0.015327, -0.028588, 0.002431, 0.002249, -0.004146, -0.011030, -0.007871, 0.002565, 0.014287, 0.003991, 0.003379, 0.002807, 0.004973, 0.007188, 0.008608, 0.000280, 0.010955, 0.007470, -0.014162, 0.005389, 0.010510, 0.006698, -0.006792, -0.000687, 0.009010, 0.001800, 0.004551, 0.007019, 0.027791, -0.003670, 0.007621, -0.010627, -0.014169, -0.019879, -0.000595, -0.010103, -0.016636, -0.021251, -0.007721, -0.002414, -0.008574, 0.003213, -0.003878, -0.001202, -0.015909, -0.013728, -0.009560, 0.014483, 0.019494, 0.007435, 0.007483, -0.002511, -0.022224, -0.094895, -0.072960, -0.001724, -0.042515, -0.013786, 0.010085, 0.008949, 0.014600, 0.039288, 0.034146, 0.017248, -0.002317, -0.000205, 0.021960, 0.015709, 0.024028, 0.041277, 0.043271, 0.028935, 0.059455, 0.047709, 0.027487, 0.021395, 0.020035, 0.042399, 0.055143, 0.063079, 0.061488, 0.042648, 0.011971, -0.002715, -0.004037, 0.021898, 0.044846, 0.044213, 0.002529, -0.008475, -0.019809, -0.031572, -0.019663, -0.029990, -0.015037, -0.005656, -0.003804, 0.006599, 0.006967, 0.012206, 0.003645, -0.000380, -0.016861, -0.029313, -0.014326, -0.007839, -0.007104, 0.001378, 0.016851, 0.015511, 0.004043, -0.009542, -0.013160, -0.011601, -0.004024, 0.011672, 0.007937, -0.000917, -0.008196, -0.028283, -0.080373, -0.040271, 0.038480, -0.012522, -0.022957, 0.042027, 0.030157, 0.016997, 0.025260, -0.013040, -0.017058, -0.022134, -0.025069, -0.026049, -0.046872, -0.056513, -0.043590, -0.062824, -0.035498, -0.056388, -0.040433, -0.035539, -0.009678, -0.015384, -0.016014, 0.001876, -0.007810, -0.008348, -0.017265, -0.007962, -0.000828, 0.003205, -0.002100, 0.003998, 0.019551, 0.001893, 0.002143, 0.018578, 0.023052, 0.011127, 0.012016, 0.010337, -0.003463, 0.004861, -0.006073, -0.008331, -0.006481, 0.011671, -0.011095, -0.006745, -0.012355, -0.017766, -0.007126, -0.017478, 0.000232, -0.014810, -0.008074, -0.012766, -0.005789, -0.014296, -0.006353, -0.008236, 0.000641, 0.013091, 0.012730, -0.007214, -0.005558, -0.010463, -0.012657, -0.003362, -0.001912, 0.010942, 0.025625, -0.000524, 0.010152, 0.062530, -0.061114, -0.089530, 2.541858, -1.784909, -2.426052, -2.450723, -2.312108, -2.003803, -1.656322, -1.333090, -1.063189, -0.840932, -0.655033, -0.503561, -0.385808, -0.300737, -0.223876, -0.173890, -0.129135, -0.086391, -0.061279, -0.035060, -0.037582, -0.023566, -0.022342, -0.018335, -0.012305, -0.011674, -0.027480, -0.022115, -0.003854, 0.002007, 0.014603, 0.001398, -0.008121, 0.003062, 0.003300, 0.013437, -0.001650, -0.003921, 0.005603, -0.000054, 0.010601, 0.013565, 0.009441, 0.003382, 0.005828, 0.002818, 0.013327, 0.001195, 0.001782, 0.022202, 0.030412, 0.033083, 0.025592, 0.032777, 0.029522, 0.016766, 0.025187, 0.017195, 0.005896, 0.003426, -0.004319, -0.012907, 0.002250, 0.012113, 0.009037, 0.004363, -0.025058, -0.065049, -0.059603, 0.009943, -0.027004, -0.007224, 0.032118, 0.005369, 0.016898, 0.023004, -0.001177, -0.013889, -0.018117, -0.027075, -0.023549, -0.027010, -0.014967, -0.014740, -0.005443, 0.004158, -0.008870, -0.006503, -0.005099, 0.012733, 0.012475, 0.008134, 0.002444, 0.007575, 0.008085, 0.009265, 0.003111, 0.013504, 0.018012, 0.013295, 0.008890, 0.009728, 0.006924, 0.026726, 0.016131, -0.002358, 0.013794, 0.019825, 0.008082, 0.004536, -0.002177, 0.007300, 0.004687, -0.000421, -0.010195, 0.002430, -0.002441, -0.010992, 0.002561, -0.005623, 0.006896, 0.000672, -0.009314, -0.006838, 0.008162, -0.008921, -0.011760, 0.000509, -0.004201, 0.011455, 0.010803, 0.002090, 0.006726, 0.010997, 0.015159, 0.001286, 0.010458, 0.021728, 0.027050, 0.019207, 0.007997, 0.003802, 0.008221, -0.046958, -0.083210, -0.040931, 0.015344, -0.015484,
0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.519999, 0.519999, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.519999, 0.519999, 0.519999, 0.519999, 0.519999, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.500000, 0.500000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.500000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.510000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.510000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.510000, 0.510000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.490000, 0.500000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.480000, 0.490000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.500000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.510000, 0.510000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.510000, 0.510000, 0.510000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.480000, 0.490000, 0.480000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.490000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000, 0.500000,
103, 101, 98, 99, 103, 109, 103, 112, 112, 114, 124, 125, 77, 112, 114, 122, 121, 114, 117, 117, 117, 121, 121, 121, 126, 122, 117, 118, 128, 153, 142, 136, 126, 121, 108, 106, 105, 106, 107, 106, 106, 106, 108, 109, 111, 113, 115, 118, 122, 128, 129, 131, 133, 134, 138, 139, 143, 144, 148, 150, 152, 153, 156, 156, 155, 157, 157, 156, 157, 156, 158, 159, 158, 158, 158, 158, 158, 158, 157, 154, 156, 157, 157, 157, 155, 154, 156, 154, 155, 154, 154, 154, 152, 153, 153, 153, 153, 153, 152, 152, 151, 149, 148, 150, 148, 145, 142, 140, 138, 138, 136, 126, 121, 116, 112, 110, 102, 95, 90, 84, 79, 76, 69, 63, 59, 59, 53, 51, 46, 45, 44, 44, 42, 42, 42, 39, 41, 40, 41, 40, 41, 42, 41, 40, 42, 41, 41, 39, 40, 40, 41, 41, 42, 39, 39, 39, 38, 38, 38, 39, 39, 40, 41, 39, 39, 38, 38, 39, 38, 40, 38, 36, 38, 38, 40, 39, 41, 41, 43, 47, 51, 52, 53, 54, 63, 66, 69, 74, 76, 85, 88, 98, 100, 104, 110, 115, 121, 124, 129, 132, 138, 140, 145, 150, 151, 151, 151, 153, 153, 153, 155, 154, 155, 154, 154, 155, 157, 155, 156, 156, 154, 154, 154, 152, 154, 153, 153, 152, 154, 155, 154, 154, 156, 154, 156, 156, 157, 158, 157, 158, 159, 158, 162, 162, 164, 159, 160, 163, 165, 164, 165, 162, 160, 157, 160, 158, 158, 153, 149, 144, 140, 137, 134, 129, 125, 116, 112, 110, 101, 103, 98, 92, 83, 79, 78, 82, 72, 69, 70, 67, 65, 60, 58, 56, 53, 52, 50, 49, 48, 42, 41, 41, 40, 39, 38, 36, 36, 32, 34, 36, 32, 30, 30, 30, 30, 30, 27, 28, 29, 32, 30, 30, 30, 31, 30, 31, 31, 34, 33, 33, 33, 34, 33, 35, 36, 39, 43, 46, 49, 50, 52, 56, 55, 60, 60, 69, 73, 73, 81, 86, 90, 94, 101, 102, 105, 112, 121, 127, 125, 130, 135, 139, 144, 146, 150, 151, 152, 154, 152, 154, 155, 154, 155, 156, 153, 155, 157, 156, 154, 155, 156, 157, 157, 157, 154, 153, 155, 157, 157, 159, 160, 159, 160, 164, 162, 162, 163, 165, 167, 169, 170, 168, 171, 171, 170, 170, 172, 170, 168, 169, 167, 166, 164, 163, 160, 159, 155, 157, 149, 146, 141, 138, 134, 127, 119, 113, 110, 105, 98, 94, 91, 84, 80, 80, 76, 71, 66, 65, 69, 64, 60, 60, 59, 60, 60, 53, 50, 52, 53, 48, 50, 42, 45, 47, 42, 40, 40, 36, 33, 30, 29, 30, 24, 25, 24, 22, 21, 22, 18, 22, 17, 17, 19, 20, 21, 22, 25, 24, 21, 26, 26, 27, 27, 30, 33, 34, 33, 38, 41, 44, 48, 51, 54, 57, 61, 66, 71, 76, 82, 91, 91, 95, 102, 106, 111, 117, 121, 122, 129, 134, 140, 143, 147, 145, 149, 149, 152, 152, 154, 152, 155, 153, 152, 151, 156, 156, 154, 153, 152, 154, 153, 156, 154, 156, 158, 161, 160, 164, 167, 167, 167, 169, 170, 167, 169, 171, 171, 172, 171, 171, 168, 170, 169, 169, 166, 162, 161, 159, 158, 157, 152, 149, 146, 143, 138, 134, 129, 124, 120, 116, 107, 106, 99, 96, 93, 92, 89, 77, 84, 81, 77, 82, 79, 81, 80, 82, 84, 80, 83, 88, 79, 70, 60, 59, 62, 62, 65, 66, 64, 70, 79, 77, 79, 77, 81, 88, 90, 92, 96, 96, 94, 94, 91, 87, 83, 89, 85, 73, 72, 68, 60, 56, 47, 39, 34, 29, 25, 15, 10, 7, 5, 3, 6, 9, 9, 13, 22, 37, 42, 47, 51, 47, 55, 62, 69, 65, 61, 68, 71, 72, 77, 79, 81, 86, 87, 87, 92, 97, 96, 100, 102, 107, 107, 112, 115, 116, 120, 122, 125, 129, 134, 136, 137, 143, 143, 147, 150, 156, 158, 161, 165, 170, 174, 177, 181, 184, 187, 192, 197, 201, 205, 208, 211, 217, 221, 227, 230, 234, 239, 245, 247, 249, 256, 257, 258, 262, 262, 264, 268, 267, 268, 269, 269, 268, 264, 260, 260, 256, 254, 250, 250, 247, 244, 242, 237, 233, 229, 228, 224, 221, 217, 212, 212, 208, 204, 201, 198, 191, 189, 188, 184, 181, 177, 173, 170, 167, 161, 158, 154, 152, 144, 143, 143, 134, 135, 130, 128, 124, 120, 114, 112, 106, 107, 99, 97, 93, 90, 87, 84, 81, 79, 76, 73, 69, 67, 66, 62, 58, 56
};


// 矩阵转置
static inline void mat_trans(const arm_matrix_instance_f32 *pSrc, arm_matrix_instance_f32 *pDst)
{
    configASSERT(ARM_MATH_SUCCESS == arm_mat_trans_f32(pSrc, pDst));
}
// 矩阵求逆
static inline void mat_inv(const arm_matrix_instance_f32 *pSrc, arm_matrix_instance_f32 *pDst)
{
    configASSERT(ARM_MATH_SUCCESS == arm_mat_inverse_f32(pSrc, pDst));
}
// 矩阵相乘
static inline void mat_mult(const arm_matrix_instance_f32 *pSrcA, const arm_matrix_instance_f32 *pSrcB, arm_matrix_instance_f32 *pDst)
{
    configASSERT(ARM_MATH_SUCCESS == arm_mat_mult_f32(pSrcA, pSrcB, pDst));
}
// 求根号
static inline float arm_sqrt(float32_t in)
{
    float pOut = 0;
    arm_status result = arm_sqrt_f32(in, &pOut);
    configASSERT(ARM_MATH_SUCCESS == result);
    return pOut;
}

void relativeLocoInit(void)
{
    if (isInit)
    {
        return;
    }
    MY_UWB_ADDRESS = getUWBAddress();
    xTaskCreate(relativeLocoTask, "relative_Localization", ZRANGER_TASK_STACKSIZE, NULL, ZRANGER_TASK_PRI, NULL);
    isInit = true;
}

void relaVarInit(relaVariable_t *relaVar, uint16_t neighborAddress)
{
    ASSERT(neighborAddress <= RANGING_TABLE_SIZE);
    for (int i = 0; i < STATE_DIM_rl; i++)
    {
        for (int j = 0; j < STATE_DIM_rl; j++)
        {
            relaVar[neighborAddress].P[i][j] = 0;
        }
    }
    relaVar[neighborAddress].P[STATE_rlX][STATE_rlX] = InitCovPos;
    relaVar[neighborAddress].P[STATE_rlY][STATE_rlY] = InitCovPos;
    relaVar[neighborAddress].P[STATE_rlYaw][STATE_rlYaw] = InitCovYaw;
    relaVar[neighborAddress].S[STATE_rlX] = 0;
    relaVar[neighborAddress].S[STATE_rlY] = 0;
    relaVar[neighborAddress].S[STATE_rlYaw] = 0;
    // relaVar[neighborAddress].S[STATE_rlX] = initRelativePosition[neighborAddress][MY_UWB_ADDRESS][STATE_rlX]; // 设定初始位置
    // relaVar[neighborAddress].S[STATE_rlY] = initRelativePosition[neighborAddress][MY_UWB_ADDRESS][STATE_rlY];
    // relaVar[neighborAddress].S[STATE_rlYaw] = initRelativePosition[neighborAddress][MY_UWB_ADDRESS][STATE_rlYaw];
    /*设定初始位置*/
    relaVar[neighborAddress].S[STATE_rlX] = initPositionRela0[neighborAddress][STATE_rlX] - initPositionRela0[MY_UWB_ADDRESS][STATE_rlX]; // 设定初始位置
    relaVar[neighborAddress].S[STATE_rlY] = initPositionRela0[neighborAddress][STATE_rlY] - initPositionRela0[MY_UWB_ADDRESS][STATE_rlY];
    relaVar[neighborAddress].S[STATE_rlYaw] = 0;
    /*----------*/
    relaVar[neighborAddress].oldTimetick = xTaskGetTickCount();
    fullConnect = true;
    // DEBUG_PRINT("%f\n", relaVar[neighborAddress].S[STATE_rlX]);
}

void relativeLocoTask(void *arg)
{
    /* 这块用于在指定无人机的初始位置时使用
    initRelativePosition[0][1][STATE_rlX] = 1; // 0号无人机相对于1号无人机的相对位置
    initRelativePosition[0][1][STATE_rlY] = -1;
    initRelativePosition[1][0][STATE_rlX] = -1; // 1号无人机相对于0号无人机的相对位置
    initRelativePosition[1][0][STATE_rlY] = 1;
    */
    systemWaitStart();
    int curi = 0;
    while (1)
    {
        vTaskDelay(10);
        getCurrentNeighborAddressInfo_t(&currentNeighborAddressInfo); // TODO
        for (int index = 0; index < currentNeighborAddressInfo.size; index++)
        {
            connectCount = 0;
            address_t neighborAddress = currentNeighborAddressInfo.address[index];
            bool isNewAdd; // 邻居是否是新加入的

            if (getNeighborStateInfo(neighborAddress, &dij, &vxj_t, &vyj_t, &rj, &hj_t, &isNewAdd))
            {
                // DEBUG_PRINT("start：%d\n", xTaskGetTickCount());
                vxj = (vxj_t + 0.0) / 100;
                vyj = (vyj_t + 0.0) / 100;
                hj = (hj_t + 0.0) / 100;
                //  使用固定数据

                vxj = data[0][curi];
                vyj = data[1][curi];
                rj = data[2][curi];
                hj = data[3][curi];
                dij = data[4][curi];
                curi += 1;

                //  使用固定数据
                if (isNewAdd)
                {
                    relaVarInit(relaVar, neighborAddress);
                }
                else
                {
                    estimatorKalmanGetSwarmInfo(&vxi_t, &vyi_t, &ri, &hi_t); // 当前无人机的信息
                    vxi = (vxi_t + 0.0) / 100;
                    vyi = (vyi_t + 0.0) / 100;
                    hi = (hi_t + 0.0) / 100;
                    uint32_t osTick = xTaskGetTickCount();
                    float dtEKF = (float)(osTick - relaVar[neighborAddress].oldTimetick) / configTICK_RATE_HZ;
                    relaVar[neighborAddress].oldTimetick = osTick;
                    DEBUG_PRINT("%d,%f,%f,%f,%f,%d\n",xTaskGetTickCount(),vxi,vyi,hi,ri,dij);
                    relativeEKF(neighborAddress, vxi, vyi, ri, hi, vxj, vyj, rj, hj, dij, dtEKF);
                }
                // DEBUG_PRINT("addr:%d,X:%f,Y:%f",neighborAddress,relaVar[neighborAddress].S[STATE_rlX],relaVar[neighborAddress].S[STATE_rlY]);
            }
        }
    }
    connectCount++;
    // DEBUG_PRINT("%d\n", connectCount);
    if (connectCount < 1000) // // 这里我设定的是60s没有测距，fullConnect=false
    {
        fullConnect = true; // disable control if there is no ranging after 1 second
    }
    else
    {
        // DEBUG_PRINT("------------");
        fullConnect = false;
    }
}

void relativeEKF(int n, float vxi, float vyi, float ri, float hi, float vxj, float vyj, float rj, float hj, uint16_t dij, float dt)
{
    // some preprocessing
    arm_matrix_instance_f32 Pm = {STATE_DIM_rl, STATE_DIM_rl, (float *)relaVar[n].P};
    float cyaw = arm_cos_f32(relaVar[n].S[STATE_rlYaw]);
    float syaw = arm_sin_f32(relaVar[n].S[STATE_rlYaw]);
    float xij = relaVar[n].S[STATE_rlX];
    float yij = relaVar[n].S[STATE_rlY];

    // prediction
    relaVar[n].S[STATE_rlX] = xij + (cyaw * vxj - syaw * vyj - vxi + ri * yij) * dt;
    relaVar[n].S[STATE_rlY] = yij + (syaw * vxj + cyaw * vyj - vyi - ri * xij) * dt;
    relaVar[n].S[STATE_rlYaw] = relaVar[n].S[STATE_rlYaw] + (rj - ri) * dt;
    // A状态转移矩阵
    A[0][0] = 1;
    A[0][1] = ri * dt;
    A[0][2] = (-syaw * vxj - cyaw * vyj) * dt;
    A[1][0] = -ri * dt;
    A[1][1] = 1;
    A[1][2] = (cyaw * vxj - syaw * vyj) * dt;
    A[2][0] = 0;
    A[2][1] = 0;
    A[2][2] = 1;

    mat_mult(&Am, &Pm, &tmpNN1m);      // A P
    mat_trans(&Am, &tmpNN2m);          // A'
    mat_mult(&tmpNN1m, &tmpNN2m, &Pm); // A P A'

    // BQB' = [ Qv*c^2 + Qv*s^2 + Qr*y^2 + Qv,                       -Qr*x*y, -Qr*y]
    //        [                       -Qr*x*y, Qv*c^2 + Qv*s^2 + Qr*x^2 + Qv,  Qr*x]
    //        [                         -Qr*y,                          Qr*x,  2*Qr]*dt^2
    float dt2 = dt * dt;
    relaVar[n].P[0][0] += dt2 * (Qv + Qv + Qr * yij * yij);
    relaVar[n].P[0][1] += dt2 * (-Qr * xij * yij);
    relaVar[n].P[0][2] += dt2 * (-Qr * yij);
    relaVar[n].P[1][0] += dt2 * (-Qr * xij * yij);
    relaVar[n].P[1][1] += dt2 * (Qv + Qv + Qr * xij * xij);
    relaVar[n].P[1][2] += dt2 * (Qr * xij);
    relaVar[n].P[2][0] += dt2 * (-Qr * yij);
    relaVar[n].P[2][1] += dt2 * (Qr * xij);
    relaVar[n].P[2][2] += dt2 * (2 * Qr);

    xij = relaVar[n].S[STATE_rlX];
    yij = relaVar[n].S[STATE_rlY];
    float distPred = arm_sqrt(xij * xij + yij * yij + (hi - hj) * (hi - hj)) + 0.0001f;
    float distMeas = (float)(dij / 100.0f);
    // h矩阵
    h[0] = xij / distPred;
    h[1] = yij / distPred;
    h[2] = 0;

    mat_trans(&H, &HTm);        // H'
    mat_mult(&Pm, &HTm, &PHTm); // PH'
    float HPHR = powf(Ruwb, 2); // HPH' + R
    for (int i = 0; i < STATE_DIM_rl; i++)
    {                                 // Add the element of HPH' to the above
        HPHR += H.pData[i] * PHTd[i]; // this obviously only works if the update is scalar (as in this function)
    }
    for (int i = 0; i < STATE_DIM_rl; i++)
    {
        K[i] = PHTd[i] / HPHR; // kalman gain = (PH' (HPH' + R )^-1)
        // DEBUG_PRINT("K[%d]:%f\n", i, K[i]);
        // DEBUG_PRINT("relaVarStart:%.3lf", relaVar[n].S[i]);
        relaVar[n].S[i] = relaVar[n].S[i] + K[i] * (distMeas - distPred); // state update
        // DEBUG_PRINT(",relaVar:%.3f,K:%.3f,distMeas:%.3f,distPred%.3f\n", relaVar[n].S[i], K[i], distMeas, distPred);
    }
    mat_mult(&Km, &H, &tmpNN1m); // KH
    for (int i = 0; i < STATE_DIM_rl; i++)
    {
        tmpNN1d[STATE_DIM_rl * i + i] -= 1;
    }                                  // KH - I
    mat_trans(&tmpNN1m, &tmpNN2m);     // (KH - I)'
    mat_mult(&tmpNN1m, &Pm, &tmpNN3m); // (KH - I)*P
    mat_mult(&tmpNN3m, &tmpNN2m, &Pm); // (KH - I)*P*(KH - I)'
    // DEBUG_PRINT("dis:%d\n", dij);
}

bool relativeInfoRead(float *relaVarParam, currentNeighborAddressInfo_t *dest)
{
    if (fullConnect)
    {
        for (int index = 0; index < currentNeighborAddressInfo.size; index++)
        {
            address_t neighborAddress = currentNeighborAddressInfo.address[index];
            *(relaVarParam + neighborAddress * STATE_DIM_rl + 0) = relaVar[neighborAddress].S[STATE_rlX];
            *(relaVarParam + neighborAddress * STATE_DIM_rl + 1) = relaVar[neighborAddress].S[STATE_rlY];
            *(relaVarParam + neighborAddress * STATE_DIM_rl + 2) = relaVar[neighborAddress].S[STATE_rlYaw];
        }
        memcpy(dest->address, currentNeighborAddressInfo.address, sizeof(currentNeighborAddressInfo.address));
        dest->size = currentNeighborAddressInfo.size;
        return true;
    }
    else
    {
        return false;
    }
}
void copyTargetList(float_t *dest,float_t *src){
  for (int i = 0; i < ARRAY_LENGTH; i++)
  {
    *(dest+i*STATE_DIM_rl+0) = *(src+i*STATE_DIM_rl+0);
    *(dest+i*STATE_DIM_rl+1) = *(src+i*STATE_DIM_rl+1);
    *(dest+i*STATE_DIM_rl+2) = *(src+i*STATE_DIM_rl+2);
  }
}

LOG_GROUP_START(relative_pos)
LOG_ADD(LOG_FLOAT, rlX0, &relaVar[0].S[STATE_rlX])
LOG_ADD(LOG_FLOAT, rlY0, &relaVar[0].S[STATE_rlY])
LOG_ADD(LOG_FLOAT, rlYaw0, &relaVar[0].S[STATE_rlYaw])

LOG_ADD(LOG_FLOAT, rlX1, &relaVar[1].S[STATE_rlX])
LOG_ADD(LOG_FLOAT, rlY1, &relaVar[1].S[STATE_rlY])
LOG_ADD(LOG_FLOAT, rlYaw1, &relaVar[1].S[STATE_rlYaw])

LOG_ADD(LOG_FLOAT, rlX2, &relaVar[2].S[STATE_rlX])
LOG_ADD(LOG_FLOAT, rlY2, &relaVar[2].S[STATE_rlY])
LOG_ADD(LOG_FLOAT, rlYaw2, &relaVar[2].S[STATE_rlYaw])

LOG_ADD(LOG_FLOAT, rlX3, &relaVar[3].S[STATE_rlX])
LOG_ADD(LOG_FLOAT, rlY3, &relaVar[3].S[STATE_rlY])
LOG_ADD(LOG_FLOAT, rlYaw3, &relaVar[3].S[STATE_rlYaw])

LOG_ADD(LOG_FLOAT, rlX4, &relaVar[4].S[STATE_rlX])
LOG_ADD(LOG_FLOAT, rlY4, &relaVar[4].S[STATE_rlY])
LOG_ADD(LOG_FLOAT, rlYaw4, &relaVar[4].S[STATE_rlYaw])

LOG_ADD(LOG_FLOAT, rlX5, &relaVar[5].S[STATE_rlX])
LOG_ADD(LOG_FLOAT, rlY5, &relaVar[5].S[STATE_rlY])
LOG_ADD(LOG_FLOAT, rlYaw5, &relaVar[5].S[STATE_rlYaw])
LOG_GROUP_STOP(relative_pos)

PARAM_GROUP_START(arelative_pos)
PARAM_ADD(PARAM_FLOAT, noiFlow, &Qv) // make sure the name is not too long
PARAM_ADD(PARAM_FLOAT, noiGyroZ, &Qr)
PARAM_ADD(PARAM_FLOAT, noiUWB, &Ruwb)
PARAM_ADD(PARAM_FLOAT, Ppos, &InitCovPos)
PARAM_ADD(PARAM_FLOAT, Pyaw, &InitCovYaw)
PARAM_GROUP_STOP(arelative_pos)